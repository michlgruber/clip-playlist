<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Clip-Playlist ‚Äì fehlerfrei</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
  #playlist { list-style: none; padding: 0; margin: 20px auto; width: 560px; }
  #playlist li {
    padding: 10px; margin: 6px 0;
    background: #f0f0f0; border: 1px solid #ccc;
    display: flex; flex-wrap: wrap; gap: 6px;
    align-items: center;
  }
  input { width: 60px; }
</style>
</head>
<body>

<h1>Clip-Playlist (stabil & erlaubt)</h1>

<div>
  <input id="videoUrl" placeholder="YouTube-Link" size="42">
  Start <input id="startTime" type="number" value="0">
  End <input id="endTime" type="number" value="10">
  <button onclick="addClip()">‚ûï Clip</button>
</div>

<ul id="playlist"></ul>

<button onclick="playPlaylist()">‚ñ∂ Playlist starten</button>

<h3>Vorschau</h3>
<div id="previewPlayer"></div>

<h3>Hauptplayer</h3>
<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
const videoUrl  = document.getElementById("videoUrl");
const startTime = document.getElementById("startTime");
const endTime   = document.getElementById("endTime");
const playlist  = document.getElementById("playlist");

let clips = [];
let current = 0;
let player = null;
let preview = null;

/* ===== YouTube API ===== */
function onYouTubeIframeAPIReady() {
  // Player werden ERST erstellt, wenn ein Clip gespielt wird
}

/* ===== Clip hinzuf√ºgen ===== */
function addClip() {
  const url = videoUrl.value.trim();
  const start = Number(startTime.value) || 0;
  const end   = Number(endTime.value) || start + 10;

  const match = url.match(/(?:v=|\.be\/)([a-zA-Z0-9_-]{11})/);
  if (!match) {
    alert("Ung√ºltiger YouTube-Link");
    return;
  }

  clips.push({ id: match[1], start, end });
  videoUrl.value = "";
  render();
}

/* ===== Playlist ===== */
function render() {
  playlist.innerHTML = "";
  clips.forEach((c, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${c.id}
      Start <input type="number" value="${c.start}" onchange="edit(${i},'start',this.value)">
      End <input type="number" value="${c.end}" onchange="edit(${i},'end',this.value)">
      <button onclick="previewClip(${i})">üëÅ</button>
      <button onclick="removeClip(${i})">‚úñ</button>
    `;
    playlist.appendChild(li);
  });
}

/* ===== Player-Erzeugung (wichtig!) ===== */
function ensurePlayers(videoId) {
  if (!player) {
    player = new YT.Player('player', {
      height: '450',
      width: '800',
      videoId,
      playerVars: {
        origin: location.origin
      },
      events: { onStateChange }
    });
  }
  if (!preview) {
    preview = new YT.Player('previewPlayer', {
      height: '225',
      width: '400',
      videoId,
      playerVars: {
        origin: location.origin
      }
    });
  }
}

/* ===== Vorschau ===== */
function previewClip(i) {
  current = i;
  const c = clips[i];
  ensurePlayers(c.id);
  preview.loadVideoById({
    videoId: c.id,
    startSeconds: c.start,
    endSeconds: c.end
  });
}

/* ===== Abspielen ===== */
function playPlaylist() {
  if (!clips.length) return;
  current = 0;
  playClip(current);
}

function playClip(i) {
  const c = clips[i];
  ensurePlayers(c.id);
  player.loadVideoById({
    videoId: c.id,
    startSeconds: c.start,
    endSeconds: c.end
  });
  previewClip(i);
}

/* ===== Weiter ===== */
function onStateChange(e) {
  if (e.data === YT.PlayerState.ENDED) {
    current++;
    if (current < clips.length) playClip(current);
  }
}

function edit(i, k, v) { clips[i][k] = Number(v); }
function removeClip(i) { clips.splice(i, 1); render(); }
</script>

</body>
</html>
